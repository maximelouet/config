#!/bin/sh
#
# Saumon i3blocks scripts
# INTERNET (wired/wifi network info with external ip on middle click)
#

ifaceWIFI=$(echo /sys/class/net/*/wireless | awk -F '/' '{ print $5 }')
ifaceETH=$(echo /sys/class/net/en*/ | awk -F '/' '{ print $5 }')
ifaceVPN=$(echo /sys/class/net/ppp*/ | awk -F '/' '{ print $5 }')

case $BLOCK_BUTTON in
  2)
    IP=$(curl -s "https://ip.saumon.io" | tr -d '\n')
    notify-send "External IP address" "$IP"
    printf "%s" "$IP" | xclip -i -selection clipboard 2>/dev/null
    ;;
  3)
    IP=$(ip addr show "$ifaceWIFI" | awk '/inet / {print $2}' | cut -d '/' -f1 | tr -d '\n')
    notify-send "IP address" "$IP"
    printf "%s" "$IP" | xclip -i -selection clipboard 2>/dev/null
    ;;
esac

if [ -n "$ifaceWIFI" ] && [ "$ifaceWIFI" != "*" ]; then
  statusWIFI=$(cat -- "$(readlink -e -- /sys/class/net/"$ifaceWIFI"/operstate)")
else
  statusWIFI="unknown"
fi

if [ -n "$ifaceETH" ] && [ "$ifaceETH" != "en*" ]; then
  statusETH=$(cat -- "$(readlink -e -- /sys/class/net/"$ifaceETH"/operstate)")
else
  statusETH="unknown"
fi

if [ "$statusETH" = "up" ]; then
  printf '<span color="#8BC34A"><b></b>  '
  ip addr show "$ifaceETH" | awk '/inet / {print $2}' | cut -d '/' -f1 | tr -d '\n'
  printf '</span>\n'
elif [ "$statusWIFI" = "up" ]; then
  IPaddr=$(ip addr show "$ifaceWIFI" | awk '/inet / {print $2}' | cut -d '/' -f1 | tr -d '\n')
  NetName=$(iwgetid -r | tr -d '\n')
  if [ "$IPaddr" = "" ]; then
    printf "<span color='#EF6C00'>  (no IP)</span>\n"
  else
    printf "<span color='#8BC34A'>  "
    case "$IPaddr" in
      192.168.*) printf "%s" "${IPaddr#'192.168.'}" ;;
      10.41.*) printf "<span font_size='small'>10.41.</span>%s" "${IPaddr#'10.41.'}" ;;
      *) printf "%s" "$IPaddr" ;;
    esac
    printf "</span> <span font_size='small'>on</span> "
    case "$NetName" in
      *-5GHz) printf "%s <span color='#1E88E5' font_weight='bold'>5</span>" "${NetName%?????}" ;;
      *-5G) printf "%s <span color='#1E88E5' font_weight='bold'>5</span>" "${NetName%???}" ;;
      *) printf "%s" "$NetName" ;;
    esac
    if [ "$ifaceVPN" != "ppp*" ]; then
      printf "<span color='#EC407A'> </span>"
    fi
    printf "\n"
  fi
else
  printf "<span color='#f44336' font-weight='bold'>INTERNET ?</span>\n"
fi
